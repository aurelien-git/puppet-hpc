#!/bin/bash
#####################################################################
# Automatic generation of SSH keys for users
#####################################################################
# NOTE: This file is automatically generated by puppet.
# Changes to this file will be overwritten periodically by puppet!
#####################################################################
# TEMPLATE: {<%= @name %>}/<%= File.basename(__FILE__) %>}
#####################################################################

CLUSTER="<%= @cluster %>"
USERS_GROUP="<%= @authorized_users_group %>"
SSH_KEY_TYPE="<%= @autogen_key_type %>"
SSH_KEY_LENGTH="<%= @autogen_key_length %>"
SSH_KEY_NAME="id_${SSH_KEY_TYPE}_${SSH_KEY_LENGTH}_${CLUSTER}"
SSH_KEY_PATH="${HOME}/.ssh/${SSH_KEY_NAME}"

if test -d ${HOME} && [ "`id -u`" -ne 0 ] && grep -q $USERS_GROUP <(id -Gn $USER) ; then
        if [ ! -f ${SSH_KEY_PATH} ]
        then
                echo "Generating a new SSH key for $CLUSTER internal use"
                if [ ! -d $HOME/.ssh ]
                then
                        mkdir $HOME/.ssh
                        chmod 700 $HOME/.ssh
                fi
                ssh-keygen -t $SSH_KEY_TYPE -b $SSH_KEY_LENGTH -C "$CLUSTER" -q -f $SSH_KEY_PATH -N ""
        fi

        cat ${SSH_KEY_PATH}.pub >> $HOME/.ssh/authorized_keys
        chmod 600 $HOME/.ssh/authorized_keys

        if ! grep -q ${SSH_KEY_NAME} $HOME/.ssh/config 2>/dev/null; then
                echo "IdentityFile $SSH_KEY_PATH" >> $HOME/.ssh/config
        fi
fi
