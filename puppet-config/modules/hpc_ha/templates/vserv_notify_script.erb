<% ########################################################################## -%>
<% #  Puppet configuration file                                             # -%>
<% #                                                                        # -%>
<% #  Copyright (C) 2014-2015 EDF S.A.                                      # -%>
<% #  Contact: CCN-HPC <dsp-cspit-ccn-hpc@edf.fr>                           # -%>
<% #                                                                        # -%>
<% #  This program is free software; you can redistribute in and/or         # -%>
<% #  modify it under the terms of the GNU General Public License,          # -%>
<% #  version 2, as published by the Free Software Foundation.              # -%>
<% #  This program is distributed in the hope that it will be useful,       # -%>
<% #  but WITHOUT ANY WARRANTY; without even the implied warranty of        # -%>
<% #  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         # -%>
<% #  GNU General Public License for more details.                          # -%>
<% ########################################################################## -%>
#!/bin/bash
#####################################################################
# Script to switch the Direct Routing for hpc_ha::vip <%= @vip_name %>
#
#  This script is called by the notify script when keepalived changes
#  the state.
#
#  When the node is backup, it should have the IP address configured
#  on the loopback (lo) interface to accept connections.
#####################################################################
# NOTE: This file is automatically generated by puppet.
# Changes to this file will be overwritten periodically by puppet!
#####################################################################
# TEMPLATE: {<%= @name %>}/<%= File.basename(__FILE__) %>
#####################################################################
VRTADD=<%= @ip_address %>

instance_type="${1}"
instance_name="${2}"
target_state="${3}"

current_name="$(basename $0)"

logger -t ${current_name}.info "INFO: $(hostname) changed state for VIP ${VRTADD}, the new state is: ${target_state}."
case "${target_state}" in
  "MASTER")
    logger -t ${current_name}.info "INFO: $(hostname) becomes master"
    /sbin/ip addr del "${VRTADD}/32" dev lo
    /sbin/ipvsadm --restore < /tmp/keepalived.ipvs
  ;;
  "BACKUP")
    logger -t ${current_name}.info "INFO: $(hostname) becomes backup"
    /sbin/ip addr add "${VRTADD}/32" scope host dev lo
    /sbin/ipvsadm --save > /tmp/keepalived.ipvs
    /sbin/ipvsadm --clear
  ;;
  *)
    logger -t ${current_name}.info "INFO: $(hostname) is neither master nor backup"
    /sbin/ip addr del "${VRTADD}/32" dev lo
    /sbin/ipvsadm --save > /tmp/keepalived.ipvs
    /sbin/ipvsadm --clear
  ;;    
esac
~           
