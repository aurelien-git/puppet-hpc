<% ########################################################################## -%>
<% #  Puppet configuration file                                             # -%>
<% #                                                                        # -%>
<% #  Copyright (C) 2014-2015 EDF S.A.                                      # -%>
<% #  Contact: CCN-HPC <dsp-cspit-ccn-hpc@edf.fr>                           # -%>
<% #                                                                        # -%>
<% #  This program is free software; you can redistribute in and/or         # -%>
<% #  modify it under the terms of the GNU General Public License,          # -%>
<% #  version 2, as published by the Free Software Foundation.              # -%>
<% #  This program is distributed in the hope that it will be useful,       # -%>
<% #  but WITHOUT ANY WARRANTY; without even the implied warranty of        # -%>
<% #  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         # -%>
<% #  GNU General Public License for more details.                          # -%>
<% ########################################################################## -%>

#####################################################################
# Network interfaces configuration (RHEL Operating System)
# This file describes how to activate a network interface.
#####################################################################
# NOTE: This file is automatically generated by puppet.
# Changes to this file will be overwritten periodically by puppet!
#####################################################################
# TEMPLATE: {<%= @module_name %>}/<%= File.basename(__FILE__) %>} PARAM = [ <%= @target %> ]
#####################################################################
<% require 'ipaddr' -%>
<% netconfig = MasterNetwork::NETCONFIG -%>
<% defaultgw = @net_cm_defaultgw -%>
<% bondcfg = @net_cm_bondcfg -%>
<% ia = 0 -%>
<% is = 0 -%>
<% printmode = 'master' -%>
<% bondiface = String.new -%>
<% netconfig.each_key do | key| -%>
  <%- if key.include?("bond") then -%>
    <%- bondcfg[key]['slaves'].each do | iface| -%>
      <%- if iface == @target -%>
        <%- bondiface = key -%>
        <%- printmode = 'slave' -%>
      <%- end -%>
    <%- end -%>
  <%- end -%>
<% end -%>
<%= "NAME="+@target %>
<% case printmode when 'master' -%>
  <%- if netconfig.has_key?(@target) -%>
    <%- netconfig[@target].each do | addr | -%>
<%= "DEVICE="+@target %>
<%= "BOOTPROTO=none" %>
<%= "ONBOOT=yes" %>
<%= "USERCTL=no" %>
<%= "NM_CONTROLLED=no" %>
<%= "IPADDR"+ia.to_s+"="+addr.split("/")[0] %>
<%= "NETMASK"+ia.to_s+"="+addr.split("/")[1] %>
        <%- ia += 1 -%>
      <%- if @target.include?("bond") -%>
<%= "TYPE=Bond" %>
<%= "BONDING_OPTS="+'"'+bondcfg[@target]["options"]+'"' %>
<%= "BONDING_MASTER=yes" %>
         <%- bondcfg[@target]["slaves"].each do -%>
<%= "BONDING_SLAVE"+is.to_s+"="+bondcfg[@target]["slaves"][is] %>
         <%- is += 1 -%>
         <%- end -%>
      <%- end -%>
    <%- end -%>
  <%- end -%>
<%- when 'slave' -%>
  <%- if @target.include?("ib") -%>
<%= "TYPE=InfiniBand" %>
  <%- else -%>
<%= "TYPE=Ethernet" %>
  <%- end -%>
<%= "SLAVE=yes" %>
<%= "DEVICE="+@target %>
<%= "ONBOOT=yes" %>
<%= "MASTER="+bondiface %>
<% end -%>
